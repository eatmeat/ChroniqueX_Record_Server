<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChroniqueX Record Server</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link id="favicon" rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        html {
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ChroniqueX Record Server</h1>
            <div class="status-container">
                <div id="status-indicator" class="status-indicator stop"></div>
                <span id="status-text">Остановлено</span>
                <span id="status-time">(00:00:00)</span>
            </div>
        </header>

        <div id="post-process-status" class="post-process-status" style="display: none;"></div>
        <div class="controls">
            <button id="rec-btn" class="control-btn rec-btn">REC</button>
            <button id="pause-btn" class="control-btn pause-btn" disabled>PAUSE</button>
            <button id="stop-btn" class="control-btn stop-btn" disabled>STOP</button>
        </div>

        <main>
            <div class="tabs">
                <button class="tab-link active" data-tab="recordings-tab">Записи</button>
                <button class="tab-link" data-tab="settings-tab">Настройки</button>
                <button class="tab-link" data-tab="contacts-tab">Участники <span id="selected-contacts-count"></span></button>
            </div>

            <div id="recordings-tab" class="tab-content active">
                <div id="recordings-list">
                    {% for group in date_groups %}
                    <div class="date-group">
                        <h3>{{ group.formatted_date }} <span>({{ group.day_of_week }})</span></h3>
                        <ul class="recording-items">
                            {% for rec in group.recordings %}
                            <li class="recording-item">
                                <div class="item-main">
                                    <span class="rec-time">{{ rec.time }}</span>
                                    <a href="/files/{{ group.date }}/{{ rec.filename }}" target="_blank" class="rec-filename">{{ rec.filename }}</a>
                                    <span class="rec-size">({{ (rec.size / 1024 / 1024) | round(2) }} MB)</span>
                                </div>
                                <div class="item-actions">
                                    {% if rec.filename.lower().endswith('.wav') %}
                                        <button class="action-btn compress-btn" data-date="{{ group.date }}" data-filename="{{ rec.filename }}">Сжать в MP3</button>
                                    {% endif %}
                                    <a href="/files/{{ group.date }}/{{ rec.transcription_filename }}" target="_blank" class="action-btn transcription-link {{ 'exists' if rec.transcription_exists }}">Транскрипция</a>
                                    <a href="/files/{{ group.date }}/{{ rec.protocol_filename }}" target="_blank" class="action-btn protocol-link {{ 'exists' if rec.protocol_exists }}">Протокол</a>
                                    <button class="action-btn recreate-transcription-btn" data-date="{{ group.date }}" data-filename="{{ rec.filename }}">Пересоздать TXT</button>
                                    <button class="action-btn recreate-protocol-btn" data-date="{{ group.date }}" data-filename="{{ rec.filename }}">Пересоздать Протокол</button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <p>Записей пока нет.</p>
                    {% endfor %}
                </div>
            </div>

            <div id="settings-tab" class="tab-content">
                <form id="settings-form">
                    <h3>Дата собрания</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="add-meeting-date" name="add_meeting_date">
                            Добавлять дату в начало промпта (в формате <code># Дата собрания: ...</code>)
                        </label>
                    </div>
                    <div class="form-group" id="meeting-date-source-group">
                        <label><input type="radio" name="meeting_date_source" value="current"> Текущая дата</label>
                        <label><input type="radio" name="meeting_date_source" value="folder"> Дата из папки с записью</label>
                    </div>


                    <h3>Дополнение к промпту</h3>
                    <div class="form-group">
                        <label for="use-custom-prompt">
                            <input type="checkbox" id="use-custom-prompt" name="use_custom_prompt">
                            Использовать дополнение к промпту
                        </label>
                    </div>
                    <div class="form-group">
                        <div class="prompt-info">
                            <p>Доступные плейсхолдеры: <code>{current_date}</code> - текущая дата.</p>
                            <p>Строки, начинающиеся с <code>//</code>, будут проигнорированы.</p>
                        </div>
                        <textarea id="prompt-addition" name="prompt_addition" rows="20"></textarea>
                    </div>

                    <h3>Правила для файлов контекста</h3>
                    <div class="prompt-info">
                        <p>Здесь можно настроить, какие файлы из папки с записью будут добавлены в контекст. В шаблоне имени файла можно использовать:</p>
                        <ul>
                            <li><code>*</code> — заменяет любую последовательность символов (например, <code>*.txt</code>).</li>
                            <li><code>?</code> — заменяет один любой символ (например, <code>task?.html</code>).</li>
                            <li><code>[]</code> — заменяет один из символов в скобках (например, <code>список[123].json</code>).</li>
                        </ul>
                        <p>Доступные плейсхолдеры в "Добавке к промпту": <code>{filename}</code>, <code>{content}</code>.</p>
                    </div>
                    <div id="context-file-rules-container"></div>
                    <button type="button" id="add-context-rule-btn" class="action-btn">Добавить правило</button>

                    <h3>Корректировка громкости</h3>
                    <div class="form-group slider-group">
                        <label for="mic-volume">Микрофона: <span id="mic-volume-value"></span> dB</label>
                        <input type="range" id="mic-volume" name="mic_volume_adjustment" min="-20" max="20" step="1" value="-3">
                    </div>
                    <div class="form-group slider-group">
                        <label for="sys-audio-volume">Системного аудио: <span id="sys-audio-volume-value"></span> dB</label>
                        <input type="range" id="sys-audio-volume" name="system_audio_volume_adjustment" min="-20" max="20" step="1" value="0">
                    </div>

                </form>
                <div id="settings-save-status" style="margin-top: 15px;"></div>
            </div>

            <div id="contacts-tab" class="tab-content">
                <p class="prompt-info">Выбранные участники будут добавлены в промпт для генерации протокола. Их количество будет использовано для определения числа спикеров при транскрибации.</p>
                
                <div id="contacts-list-container">
                    <!-- Контакты будут загружены сюда через JS -->
                </div>

                <div class="contacts-management">
                    <div class="add-item-row">
                        <input type="text" id="new-group-name" class="add-item-input" placeholder="Название новой группы...">
                        <button id="add-group-btn" class="action-btn">Добавить</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>