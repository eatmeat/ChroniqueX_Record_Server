<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChroniqueX Record Server</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/recorder.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout/tabs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/lists.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/chart.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/modal.css') }}">
    <link id="favicon" rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        html {
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="{{ url_for('static', filename='logo.png') }}" alt="ChroniqueX Record Server" class="header-logo">
            <div class="status-wrapper">
                <a href="/logout" class="logout-link">Выйти</a>
                <div class="status-container">
                    <div id="status-indicator" class="status-indicator stop"></div>
                    <span id="status-text">Остановлено</span>
                    <span id="status-time">(00:00:00)</span>
                </div>
                <div id="post-process-status" class="post-process-status">&nbsp;</div>
            </div>
        </header>
        <div class="controls">
            <button id="rec-btn" class="control-btn rec-btn">REC</button>
            <button id="pause-btn" class="control-btn pause-btn" disabled>PAUSE</button>
            <button id="stop-btn" class="control-btn stop-btn" disabled>STOP</button>
            <button id="add-file-btn" class="control-btn add-file-btn">+&nbsp;Файл</button>
            <input type="file" id="file-upload-input" accept="audio/*" style="display: none;">
            <button id="pip-btn" class="control-btn pip-btn" title="Картинка в картинке">&#x25ad;</button>
        </div>

        <!-- Контейнер для дополнительных элементов управления, включая ретрансляцию -->
        <div class="main-controls-extensions">
            <div id="relay-settings-container"></div>
        </div>

        <div class="volume-meters-container">
            <div class="volume-chart">
                <canvas id="audio-chart" width="600" height="200"></canvas>
                <div class="chart-legend">
                    <span class="legend-item mic"><span class="legend-color"></span>Микрофон</span>
                    <span class="legend-item sys"><span class="legend-color"></span>Аудио</span>
                </div>
            </div>
        </div>

        <div id="prompt-preview-container" class="prompt-preview-container" style="display: none;">
            <h4>Дополнение промпта</h4>
            <pre id="prompt-preview-content"></pre>
        </div>
        
        <div id="settings-save-status" style="text-align: center; margin-bottom: 15px; height: 1em;"></div>

        <main>
            <div class="tabs">
                <button class="tab-link active" data-tab="recordings-tab">Записи</button>
                <button class="tab-link" data-tab="settings-tab">Настройки</button>
                <button class="tab-link" data-tab="contacts-tab">Голоса&nbsp;<span id="selected-contacts-count"></span></button>
            </div>
            

            <div id="recordings-tab" class="tab-content active">
                <div id="recordings-list">
                    {% for group in date_groups %}
                    <div class="date-group collapsed" data-date="{{ group.date }}">
                        <h3>{{ group.formatted_date }} <span>({{ group.day_of_week }})</span></h3>
                        <div class="recording-table">
                            <div class="recording-table-header">
                                <div class="recording-cell cell-time">Начало</div>
                                <div class="recording-cell cell-duration">Длит.</div>
                                <div class="recording-cell cell-title">Наименование</div>
                                <div class="recording-cell cell-files">Файлы</div>
                            </div>
                            <div class="recording-table-body">
                                <!-- Строки таблицы будут загружены сюда динамически -->
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p>Записей пока нет.</p>
                    {% endfor %}
                </div>
            </div>

            <div id="settings-tab" class="tab-content">
                <form id="settings-form">
                    <div class="settings-group behavior-settings-group collapsed">
                        <h4 class="settings-group-header"><span class="expand-icon"></span>Поведение</h4>
                        <div class="settings-group-content">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="confirm-prompt-on-action" name="confirm_prompt_on_action">
                                    Уточнять добавку к промпту при остановке записи / пересоздании файлов
                                </label>
                                <p class="prompt-info">Если включено, перед выполнением действия будет показано окно для подтверждения и изменения настроек промпта и участников.</p>
                            </div>
                        </div>
                    </div>

                    <div class="settings-group collapsed">
                        <h4 class="settings-group-header"><span class="expand-icon"></span>Дата собрания</h4>
                        <div class="settings-group-content">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="add-meeting-date" name="add_meeting_date">
                                    Добавлять дату в начало промпта (в формате <code># Дата собрания: ...</code>)
                                </label>
                            </div>
                            <div class="form-group" id="meeting-date-source-group">
                                <label><input type="radio" name="meeting_date_source" value="current"> Текущая дата</label>
                                <label><input type="radio" name="meeting_date_source" value="folder"> Дата из папки с записью</label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-group collapsed">
                        <h4 class="settings-group-header"><span class="expand-icon"></span>Название собрания</h4>
                        <div class="settings-group-content">
                            <div id="meeting-name-templates-container">
                                <!-- Шаблоны будут отрисованы здесь с помощью JS -->
                            </div>
                            <button type="button" id="add-meeting-name-template-btn" class="action-btn">Добавить шаблон</button>
                        </div>
                    </div>

                    <div class="settings-group collapsed">
                        <h4 class="settings-group-header"><span class="expand-icon"></span>Правила для файлов</h4>
                        <div class="settings-group-content">
                            <div class="prompt-info">
                                <p>Здесь можно настроить, какие файлы из папки с записью будут добавлены в контекст. В шаблоне имени файла можно использовать:</p>
                                <ul>
                                    <li><code>*</code> — заменяет любую последовательность символов (например, <code>*.txt</code>).</li>
                                    <li><code>?</code> — заменяет один любой символ (например, <code>report_?.doc</code>).</li>
                                    <li><code>[]</code> — заменяет один из символов в скобках (например, <code>img[123].png</code>).</li>
                                </ul>
                                <p>Доступные плейсхолдеры в "Добавке к промпту": <code>{filename}</code>, <code>{content}</code>.</p>
                            </div>
                            <div id="context-file-rules-container"></div>
                            <button type="button" id="add-context-rule-btn" class="action-btn">Добавить правило</button>
                        </div>
                    </div>
                    
                    <div class="settings-group collapsed">
                        <h4 class="settings-group-header"><span class="expand-icon"></span>Дополнение к промпту</h4>
                        <div class="settings-group-content">
                            <div class="form-group">
                                <label for="use-custom-prompt">
                                    <input type="checkbox" id="use-custom-prompt" name="use_custom_prompt">
                                    Использовать дополнение к промпту
                                </label>
                            </div>
                            <div class="form-group">
                                <p>Доступные плейсхолдеры: <code>{current_date}</code> - текущая дата.</p>
                                <p>Строки, начинающиеся с <code>//</code>, будут проигнорированы.</p>
                                <textarea id="prompt-addition" name="prompt_addition" rows="20"></textarea>                    
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <div id="contacts-tab" class="tab-content">
                <!-- Этот контейнер будет использоваться для клонирования в модальное окно -->
                <div id="contacts-content-wrapper">
                    <p class="prompt-info">Выбранные участники будут добавлены в промпт для генерации протокола. Их количество будет использовано для определения числа спикеров при транскрибации.</p>
    
                    <div class="contacts-management">
                        <div class="add-item-row">
                            <input type="text" id="new-group-name" class="add-item-input" placeholder="Название новой группы...">
                            <button id="add-group-btn" class="action-btn">Добавить</button>
                        </div>
                    </div>
    
                    <div id="contacts-list-container">
                        <!-- Контакты будут загружены сюда через JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Модальное окно для настроек -->
    <div id="confirmation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Подтверждение настроек</h3>
                <div class="modal-actions">
                    <button id="modal-confirm-btn" class="control-btn rec-btn">Подтвердить</button>
                    <button id="modal-cancel-btn" class="control-btn stop-btn">Отмена</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-column" id="modal-settings-col">
                    <!-- <h4>Настройки</h4> -->
                    <!-- Содержимое #settings-tab будет скопировано сюда -->
                </div>
                <div class="modal-column" id="modal-contacts-col">
                    <!-- <h4>Голоса <span id="modal-selected-contacts-count" class="selected-count"></span></h4> -->
                    <!-- Содержимое #contacts-tab будет скопировано сюда -->
                </div>
                <div class="modal-column" id="modal-preview-col">
                    <!-- <h4>Предпросмотр</h4> -->
                    <!-- Содержимое #prompt-preview-container будет скопировано сюда -->
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>